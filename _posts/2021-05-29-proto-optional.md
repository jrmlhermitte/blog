---
keywords: fastai
description: "In this post I will attempt to explain the importance of optional in proto3, and what the consequences are of its absence."
title: Why you should use the new proto3 optional keyword
toc: true
branch: master
badges: true
comments: true
categories: [fastpages, jupyter]
hide: false
search_exclude: true
nb_path: _notebooks/2021-05-29-proto-optional.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-05-29-proto-optional.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="A-convincing-argument,-not-by-definition,-but-by-observation">A convincing argument, not by definition, but by observation<a class="anchor-link" href="#A-convincing-argument,-not-by-definition,-but-by-observation"> </a></h2><p>Protobufs are a quite popular message protocol used as an alternative to JSON.
Although less readable, it offers a lot more compression.
Message passing between services is pretty critical for
isolated machine learning services, which makes proto3 an ideal
candidate for these applications (for example, a classifier 
running on a GPU).</p>
<p>There are two versions: proto2 and proto3. Proto3 is supposed to be the next
version of proto2. However up until version 3.12, 
it was missing a very important feature: <code>optional</code> values. See <a href="https://github.com/protocolbuffers/protobuf/issues/1606">here</a>
for a long discussion about this.</p>
<p>Since proto 3.12 <a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.12.0">onwards</a> 
(May 2020) as an experimental feature and then officially 
supported 3.15 <a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.15.0">onwards</a>
(Feb 2021), there is an new feature allowing for defining optional 
fields for primitive fields.</p>
<p>Why has this change been made?
In this post, I will attempt to convince you why the optional field is necessary
not by definition, but by observation.
It is not the intention of this post to go into any details specific to 
the protos themselves which is well described in the references mentioned
above.</p>
<p>All the code run here can be run by clicking the google collab link on this page.</p>
<p>Let's just begin by creating a proto.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PROTO_DIR</span> <span class="o">=</span> <span class="s1">&#39;code_snippets_2021_05_29&#39;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">PROTO_DIR</span> <span class="o">+</span> <span class="s1">&#39;/user_1.proto&#39;</span>

<span class="n">my_proto</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">syntax = &quot;proto3&quot;;</span>
<span class="s2">package user_1;</span>


<span class="s2">message User {</span>
<span class="s2">    string name  = 1;</span>
<span class="s2">    uint32 age = 2;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
  <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">my_proto</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's compile it in python</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span><span class="nv">$HOME</span>/.local/proto/bin/protoc code_snippets_2021_05_29/*.proto --python_out<span class="o">=</span>.
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">code_snippets_2021_05_29</span> <span class="kn">import</span> <span class="n">user_1_pb2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's create a user with no fields</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">google.protobuf.json_format</span> <span class="kn">import</span> <span class="n">MessageToDict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's print the contents of this user.
One good way is just to convert it to a 
python dictionary.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is blank as expected. Now let's define a user with a name and age:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">MessageToDict</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;name&#39;: &#39;John&#39;, &#39;age&#39;: 10}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>John has age 10. That makes sense.
Now let's create a newborn, Sally, of age 0:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">MessageToDict</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;name&#39;: &#39;Sally&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The age is missing! That can be a problem.
Let's use a flag to force fill the age in.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">MessageToDict</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">including_default_value_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;name&#39;: &#39;Sally&#39;, &#39;age&#39;: 0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Great. We have the age again.
Now let's add an additional restriction. Sometimes
we may want to register someone, but we may not actually know their age.
In this case, let's allow it to be optional by not defining it.
Let's create a new user Randall:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Randall&#39;</span><span class="p">)</span>
<span class="n">MessageToDict</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">including_default_value_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;name&#39;: &#39;Randall&#39;, &#39;age&#39;: 0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="A-clear-problem-of-missing-information">A clear problem of missing information<a class="anchor-link" href="#A-clear-problem-of-missing-information"> </a></h2><p>We have a problem. We can't actually create a user, encoding the 
information that the age is missing!</p>
<p>Without having read anything about protobufs and simply probing this system,
we know there is an information problem here. It is not possible
to both encode 0 as meaning a missing value and an actual value!</p>
<p>How could the developers have missed this? It is unclear but I feel free to read this issue <a href="https://github.com/protocolbuffers/protobuf/issues/1606">here</a> for the full discussion.</p>
<p>It turns out, since proto 3.12, that there is now an easy fix:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;code_snippets_2021_05_29/user_2_optional.proto&#39;</span>

<span class="n">my_proto</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">syntax = &quot;proto3&quot;;</span>
<span class="s2">package user_2;</span>


<span class="s2">message User {</span>
<span class="s2">    string name  = 1;</span>
<span class="s2">    optional uint32 age = 2;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
  <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">my_proto</span><span class="p">)</span>


<span class="c1"># compile the proto</span>
<span class="o">!</span><span class="nv">$HOME</span>/.local/proto/bin/protoc code_snippets_2021_05_29/*.proto --python_out .
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's create the user again</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">code_snippets_2021_05_29</span> <span class="kn">import</span> <span class="n">user_2_optional_pb2</span>

<span class="n">user_2</span> <span class="o">=</span> <span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Randall&#39;</span><span class="p">)</span>
<span class="n">MessageToDict</span><span class="p">(</span><span class="n">user_2</span><span class="p">,</span> <span class="n">including_default_value_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;name&#39;: &#39;Randall&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Perfect! This is exactly what we wanted. All the other cases work as expected as well.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;John with an age&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">21</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sally the newborn&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Randall the unknown&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Randall&#39;</span><span class="p">),</span> <span class="n">including_default_value_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>John with an age
{&#39;name&#39;: &#39;John&#39;, &#39;age&#39;: 21}
Sally the newborn
{&#39;name&#39;: &#39;Sally&#39;, &#39;age&#39;: 0}
Randall the unknown
{&#39;name&#39;: &#39;Randall&#39;}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>But how is this happening?
Without knowing anything about protobufs, you 
can also look at their raw outputs as bytes:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;John with an age&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sally the newborn before optional (notice the information of 0 is missing)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sally the newborn after using optional&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Randall the unknown&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Randall&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>John with an age
b&#39;\n\x04John\x10\x15&#39;

Sally the newborn before optional (notice the information of 0 is missing)
b&#39;\n\x05Sally&#39;

Sally the newborn after using optional
b&#39;\n\x05Sally\x10\x00&#39;

Randall the unknown
b&#39;\n\x07Randall&#39;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By simply observing their outputs, one can see that the optional 
keyword has encoded additional information. The proto for 
Sally whose age was not defined with <code>optional</code> keyword appears 
to be missing from the byte string, whereas the proto for 
Sally whose age was defined with the <code>optional</code> string is present.
One sees this because the first proto is a substring of the second.</p>
<p>Obviously, one can refer to the documentation to understand this.
I am intentionally avoiding an explanation to underscore convincing
you by observation. This is because in the real world, we are
faced to make, intuitive quick early decisions based on logical observations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Under-the-hood">Under the hood<a class="anchor-link" href="#Under-the-hood"> </a></h2><p>Under the hood, this is converting the primitive type to a <a href="https://github.com/protocolbuffers/protobuf/blob/master/docs/implementing_proto3_presence.md#background">oneof field</a>:</p>
<blockquote><p>To minimize this risk we chose a descriptor representation that is semantically compatible with existing proto3 reflection. Every proto3 optional field is placed into a one-field oneof.</p>
</blockquote>
<p>However, all that is relevant to us I believe is the general outcome:default values are now serialized.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From the python API standpoint, this adds a new presence check feature 
<code>proto.HasField(field_name)</code> for these basic types.
Note that previously this was only allowed for <code>Message</code> 
types and not primitive types.</p>
<p>Why is this a problem? Let's look at the following example. We will define
a simple <code>User</code> proto with a <code>name</code> and <code>age</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sally_1</span> <span class="o">=</span> <span class="n">user_1_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sally_2</span> <span class="o">=</span> <span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">randall_2</span> <span class="o">=</span> <span class="n">user_2_optional_pb2</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Randall&#39;</span><span class="p">)</span>


<span class="c1"># sally_1 has no `HasField` method because age is a primitive:</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Does Sally 1 have an age?&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sally_1</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exception: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># However, sally_2 does:</span>
<span class="n">has_age</span> <span class="o">=</span> <span class="n">sally_2</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sally_2 has age defined: </span><span class="si">{</span><span class="n">has_age</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># and Randall has no age defined</span>
<span class="n">has_age</span> <span class="o">=</span> <span class="n">randall_2</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;randall_2 has age defined: </span><span class="si">{</span><span class="n">has_age</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Does Sally 1 have an age?
Exception: Can&#39;t test non-optional, non-submessage field &#34;User.age&#34; for presence in proto3.
sally_2 has age defined: True
randall_2 has age defined: False
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Alternate-Solutions">Alternate Solutions<a class="anchor-link" href="#Alternate-Solutions"> </a></h1><p>Before this change, there were many alternate solutions. 
However, none of them were very intuitive. Previously you could have:</p>
<ul>
<li>used a <code>oneof</code> field type. In this case, the user would have to check 
which type was present in order to detect a null value
(NOTE that this is actually what is happening under the hood, 
when using <code>optional</code> but with much more elegant syntax)</li>
<li>used one of the <a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto">protobuf wrapper types</a>. This would wrap primitive types into a message. Since a Message does encode presence, this solve the problem. However, the lookup of a value would involve first checking presence, and then accessing the <code>value</code> attribute of the message (since the primitive was actually defined there)</li>
<li>use two fields. The first field would be a bool which would be True if the field should be present. The second was the actual value.</li>
</ul>
<p>You may see a summary of such solutions 
from the stackoverflow post 
<a href="https://stackoverflow.com/questions/42622015/how-to-define-an-optional-field-in-protobuf-3">here</a> 
(note that the accepted answer for this stackoverflow post has 
now been changed to using <code>optional</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h1><p>That's it! Very simple. This ends this post, but feel free to read the rest for 
some history.</p>

</div>
</div>
</div>
</div>
 

